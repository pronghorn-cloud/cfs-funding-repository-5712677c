import { defineStore } from 'pinia'
import { ref } from 'vue'
import { vulnerabilityService } from '@/services/vulnerability.service'
import type { HeatmapResponse, Indicator, IndicatorCategory, SVIScore } from '@/types'

export const useVulnerabilityStore = defineStore('vulnerability', () => {
  const scores = ref<SVIScore[]>([])
  const heatmapData = ref<HeatmapResponse | null>(null)
  const categories = ref<IndicatorCategory[]>([])
  const indicators = ref<Indicator[]>([])
  const comparisonScores = ref<SVIScore[]>([])
  const isLoading = ref(false)
  const error = ref<string | null>(null)

  async function fetchScores(params?: { year?: number; region_id?: string }) {
    isLoading.value = true
    try {
      scores.value = await vulnerabilityService.getScores(params)
    } catch (e: any) {
      error.value = e.response?.data?.detail || 'Failed to fetch scores'
    } finally {
      isLoading.value = false
    }
  }

  async function fetchHeatmap(year: number) {
    isLoading.value = true
    try {
      heatmapData.value = await vulnerabilityService.getHeatmap(year)
    } catch (e: any) {
      error.value = e.response?.data?.detail || 'Failed to fetch heatmap data'
    } finally {
      isLoading.value = false
    }
  }

  async function fetchCategories() {
    try {
      categories.value = await vulnerabilityService.getCategories()
    } catch (e: any) {
      error.value = e.response?.data?.detail || 'Failed to fetch categories'
    }
  }

  async function fetchIndicators(categoryId?: string) {
    try {
      indicators.value = await vulnerabilityService.getIndicators({
        category_id: categoryId,
      })
    } catch (e: any) {
      error.value = e.response?.data?.detail || 'Failed to fetch indicators'
    }
  }

  async function compareRegions(regionIds: string[], year: number) {
    isLoading.value = true
    try {
      comparisonScores.value = await vulnerabilityService.compareRegions(regionIds, year)
    } catch (e: any) {
      error.value = e.response?.data?.detail || 'Failed to compare regions'
    } finally {
      isLoading.value = false
    }
  }

  return {
    scores,
    heatmapData,
    categories,
    indicators,
    comparisonScores,
    isLoading,
    error,
    fetchScores,
    fetchHeatmap,
    fetchCategories,
    fetchIndicators,
    compareRegions,
  }
})
