<script setup lang="ts">
import { onMounted, ref, watch } from 'vue'
import { useVulnerabilityStore } from '@/stores/vulnerability'

const vulnStore = useVulnerabilityStore()
const selectedCategory = ref<string | null>(null)

onMounted(async () => {
  await vulnStore.fetchCategories()
  await vulnStore.fetchIndicators()
})

watch(selectedCategory, async (catId) => {
  await vulnStore.fetchIndicators(catId ?? undefined)
})
</script>

<template>
  <div>
    <h1 class="text-3xl font-bold mb-6">Indicator Explorer</h1>

    <!-- Categories -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Indicator Categories ({{ vulnStore.categories.length }})</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <button
          v-for="cat in vulnStore.categories"
          :key="cat.id"
          @click="selectedCategory = selectedCategory === cat.id ? null : cat.id"
          class="p-4 border rounded-lg text-left hover:bg-gray-50 transition-colors"
          :class="{ 'border-goa-blue bg-blue-50': selectedCategory === cat.id }"
        >
          <div class="font-semibold">{{ cat.display_name }}</div>
          <div class="text-sm text-gray-500">{{ cat.indicator_count }} indicators</div>
          <div class="text-sm text-gray-500">Weight: {{ (Number(cat.weight) * 100).toFixed(1) }}%</div>
        </button>
      </div>
    </div>

    <!-- Indicators -->
    <div class="bg-white rounded-lg shadow">
      <h2 class="text-xl font-semibold p-4 border-b">
        Indicators
        <span class="text-sm font-normal text-gray-500">({{ vulnStore.indicators.length }} total)</span>
      </h2>
      <goa-table class="w-full">
        <thead>
          <tr>
            <th>Name</th>
            <th>Unit</th>
            <th>Source</th>
            <th>Weight</th>
            <th>Inverse</th>
            <th>Active</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="ind in vulnStore.indicators" :key="ind.id">
            <td>
              <div class="font-medium">{{ ind.display_name }}</div>
              <div class="text-sm text-gray-500">{{ ind.description }}</div>
            </td>
            <td>{{ ind.unit || '-' }}</td>
            <td>{{ ind.data_source || '-' }}</td>
            <td>{{ Number(ind.weight).toFixed(2) }}</td>
            <td>
              <goa-badge :content="ind.is_inverse ? 'Yes' : 'No'" :type="ind.is_inverse ? 'important' : 'midtone'" />
            </td>
            <td>
              <goa-badge :content="ind.is_active ? 'Active' : 'Inactive'" :type="ind.is_active ? 'success' : 'midtone'" />
            </td>
          </tr>
        </tbody>
      </goa-table>
    </div>
  </div>
</template>
