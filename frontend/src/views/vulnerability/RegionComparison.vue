<script setup lang="ts">
import { onMounted, ref } from 'vue'
import { useVulnerabilityStore } from '@/stores/vulnerability'
import { useGeographyStore } from '@/stores/geography'

const vulnStore = useVulnerabilityStore()
const geoStore = useGeographyStore()

const selectedRegions = ref<string[]>([])
const selectedYear = ref(new Date().getFullYear())

onMounted(async () => {
  await geoStore.fetchRegions()
})

async function compare() {
  if (selectedRegions.value.length < 2) return
  await vulnStore.compareRegions(selectedRegions.value, selectedYear.value)
}

function toggleRegion(regionId: string) {
  const idx = selectedRegions.value.indexOf(regionId)
  if (idx >= 0) {
    selectedRegions.value.splice(idx, 1)
  } else {
    selectedRegions.value.push(regionId)
  }
}
</script>

<template>
  <div>
    <h1 class="text-3xl font-bold mb-6">Region Comparison</h1>

    <!-- Region Selection -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Select Regions to Compare</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <label
          v-for="region in geoStore.regions"
          :key="region.id"
          class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50"
          :class="{ 'border-goa-blue bg-blue-50': selectedRegions.includes(region.id) }"
        >
          <input
            type="checkbox"
            :checked="selectedRegions.includes(region.id)"
            @change="toggleRegion(region.id)"
            class="rounded"
          />
          {{ region.name }}
        </label>
      </div>
      <goa-button
        type="primary"
        @_click="compare"
        :disabled="selectedRegions.length < 2"
        class="mt-4"
      >
        Compare ({{ selectedRegions.length }} selected)
      </goa-button>
    </div>

    <!-- Comparison Results -->
    <div class="bg-white rounded-lg shadow" v-if="vulnStore.comparisonScores.length > 0">
      <h2 class="text-xl font-semibold p-4 border-b">Comparison Results</h2>
      <goa-table class="w-full">
        <thead>
          <tr>
            <th>Region</th>
            <th>Composite Score</th>
            <th>Grade</th>
            <th>Risk Index</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="score in vulnStore.comparisonScores" :key="score.id">
            <td class="font-medium">{{ score.region_name || score.region_id }}</td>
            <td class="font-bold">{{ score.composite_score.toFixed(1) }}</td>
            <td><goa-badge :content="score.grade" /></td>
            <td>{{ score.risk_index?.toFixed(1) ?? 'N/A' }}</td>
          </tr>
        </tbody>
      </goa-table>
    </div>
  </div>
</template>
