<script setup lang="ts">
import { onMounted, ref, watch } from 'vue'
import { useVulnerabilityStore } from '@/stores/vulnerability'
import { useGeographyStore } from '@/stores/geography'

const vulnStore = useVulnerabilityStore()
const geoStore = useGeographyStore()

const selectedYear = ref(new Date().getFullYear())
const mapContainer = ref<HTMLElement | null>(null)

const gradeColors: Record<string, string> = {
  A: '#2e7d32',  // Green - Low vulnerability
  B: '#66bb6a',  // Light green
  C: '#fdd835',  // Yellow - Average
  D: '#ff9800',  // Orange
  E: '#d32f2f',  // Red - High vulnerability
}

onMounted(async () => {
  await Promise.all([
    vulnStore.fetchHeatmap(selectedYear.value),
    geoStore.fetchGeoJSON(),
    geoStore.fetchRegions(),
  ])
  initMap()
})

watch(selectedYear, async (year) => {
  await vulnStore.fetchHeatmap(year)
  updateMapLayer()
})

function initMap() {
  if (!mapContainer.value) return

  // Leaflet map initialization will happen after npm install
  // Using dynamic import to avoid SSR issues
  import('leaflet').then((L) => {
    const map = L.map(mapContainer.value!, {
      center: [53.9333, -116.5765], // Alberta center
      zoom: 6,
    })

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map)

    // Add GeoJSON layer with SVI coloring
    if (geoStore.geojson && vulnStore.heatmapData) {
      const scoreMap = new Map(
        vulnStore.heatmapData.data.map((d) => [d.region_id, d]),
      )

      L.geoJSON(geoStore.geojson as any, {
        style: (feature) => {
          const regionId = feature?.properties?.id
          const data = scoreMap.get(regionId)
          return {
            fillColor: data ? gradeColors[data.grade] || '#ccc' : '#ccc',
            weight: 1,
            opacity: 1,
            color: '#666',
            fillOpacity: 0.7,
          }
        },
        onEachFeature: (feature, layer) => {
          const regionId = feature?.properties?.id
          const data = scoreMap.get(regionId)
          if (data) {
            layer.bindPopup(`
              <strong>${data.region_name}</strong><br/>
              SVI Score: ${data.composite_score.toFixed(1)}<br/>
              Grade: ${data.grade}
            `)
          }
        },
      }).addTo(map)
    }
  })
}

function updateMapLayer() {
  // Re-initialize map with new data
  initMap()
}
</script>

<template>
  <div>
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Social Vulnerability Index - Heatmap</h1>
      <div class="flex items-center gap-3">
        <label for="year-select" class="text-sm font-medium">Year:</label>
        <goa-dropdown
          name="year-select"
          :value="selectedYear.toString()"
          @_change="(e: any) => selectedYear = parseInt(e.detail.value)"
        >
          <goa-dropdown-item value="2024" label="2024" />
          <goa-dropdown-item value="2023" label="2023" />
          <goa-dropdown-item value="2022" label="2022" />
        </goa-dropdown>
      </div>
    </div>

    <!-- Legend -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
      <h3 class="text-sm font-semibold mb-2">Vulnerability Grade Legend</h3>
      <div class="flex gap-4 flex-wrap">
        <div v-for="(desc, grade) in vulnStore.heatmapData?.legend ?? {}" :key="grade" class="flex items-center gap-2">
          <div class="w-5 h-5 rounded" :style="{ backgroundColor: gradeColors[grade] || '#ccc' }" />
          <span class="text-sm">{{ grade }}: {{ desc }}</span>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div class="bg-white rounded-lg shadow overflow-hidden" style="height: 600px;">
      <goa-spinner v-if="vulnStore.isLoading" />
      <div ref="mapContainer" class="w-full h-full" />
    </div>

    <!-- Region Scores Table -->
    <div class="bg-white rounded-lg shadow mt-6" v-if="vulnStore.heatmapData">
      <h2 class="text-xl font-semibold p-4 border-b">Region Scores</h2>
      <goa-table class="w-full">
        <thead>
          <tr>
            <th>Region</th>
            <th>Composite Score</th>
            <th>Grade</th>
            <th>Socioeconomic</th>
            <th>Demographic</th>
            <th>Health</th>
            <th>Housing</th>
            <th>Infrastructure</th>
            <th>Environmental</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="d in vulnStore.heatmapData.data" :key="d.region_id">
            <td class="font-medium">{{ d.region_name }}</td>
            <td class="font-bold">{{ d.composite_score.toFixed(1) }}</td>
            <td>
              <span
                class="inline-block w-8 h-8 rounded-full text-white text-center leading-8 font-bold text-sm"
                :style="{ backgroundColor: gradeColors[d.grade] }"
              >
                {{ d.grade }}
              </span>
            </td>
            <td>{{ d.category_scores.socioeconomic?.toFixed(1) ?? '-' }}</td>
            <td>{{ d.category_scores.demographic?.toFixed(1) ?? '-' }}</td>
            <td>{{ d.category_scores.health?.toFixed(1) ?? '-' }}</td>
            <td>{{ d.category_scores.housing?.toFixed(1) ?? '-' }}</td>
            <td>{{ d.category_scores.infrastructure?.toFixed(1) ?? '-' }}</td>
            <td>{{ d.category_scores.environmental?.toFixed(1) ?? '-' }}</td>
          </tr>
        </tbody>
      </goa-table>
    </div>
  </div>
</template>
