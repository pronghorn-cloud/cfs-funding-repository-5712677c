"""SVI API routes."""

import uuid

from fastapi import APIRouter, Depends, Query
from sqlalchemy.ext.asyncio import AsyncSession

from app.auth.dependencies import AdminUser, ReviewerUser
from app.database import get_db
from app.vulnerability import service
from app.vulnerability.schemas import (
    HeatmapResponse,
    IndicatorCategoryResponse,
    IndicatorResponse,
    RecalculateRequest,
    RecalculateResponse,
    SVIScoreResponse,
)

router = APIRouter(prefix="/vulnerability", tags=["vulnerability"])


@router.get("/scores", response_model=list[SVIScoreResponse])
async def get_scores(
    user: ReviewerUser,
    year: int | None = Query(None),
    region_id: uuid.UUID | None = Query(None),
    db: AsyncSession = Depends(get_db),
) -> list[SVIScoreResponse]:
    return await service.get_svi_scores(db, year, region_id)


@router.get("/heatmap", response_model=HeatmapResponse)
async def get_heatmap(
    year: int,
    user: ReviewerUser,
    db: AsyncSession = Depends(get_db),
) -> HeatmapResponse:
    return await service.get_heatmap_data(db, year)


@router.get("/compare", response_model=list[SVIScoreResponse])
async def compare_regions(
    region_ids: list[uuid.UUID] = Query(...),
    year: int = Query(...),
    user: ReviewerUser = Depends(),
    db: AsyncSession = Depends(get_db),
) -> list[SVIScoreResponse]:
    return await service.compare_regions(db, region_ids, year)


@router.get("/categories", response_model=list[IndicatorCategoryResponse])
async def list_categories(
    user: ReviewerUser,
    db: AsyncSession = Depends(get_db),
) -> list[IndicatorCategoryResponse]:
    return await service.list_categories(db)


@router.get("/indicators", response_model=list[IndicatorResponse])
async def list_indicators(
    user: ReviewerUser,
    category_id: uuid.UUID | None = Query(None),
    active_only: bool = Query(True),
    db: AsyncSession = Depends(get_db),
) -> list[IndicatorResponse]:
    return await service.list_indicators(db, category_id, active_only)


@router.post("/recalculate", response_model=RecalculateResponse)
async def recalculate_scores(
    request: RecalculateRequest,
    user: AdminUser,
    db: AsyncSession = Depends(get_db),
) -> RecalculateResponse:
    from datetime import datetime
    year = request.year or datetime.now().year
    return await service.recalculate_scores(
        db, year, request.normalization_method, request.region_ids
    )
