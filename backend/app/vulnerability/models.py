"""SVI database models."""

import uuid
from datetime import datetime
from decimal import Decimal

from sqlalchemy import Boolean, DateTime, Float, ForeignKey, Integer, Numeric, String, Text, func
from sqlalchemy.dialects.postgresql import JSONB, UUID
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.common.base_model import TimestampMixin, UUIDPrimaryKeyMixin
from app.database import Base


class IndicatorCategory(Base, UUIDPrimaryKeyMixin, TimestampMixin):
    __tablename__ = "indicator_categories"

    name: Mapped[str] = mapped_column(String(100), unique=True, nullable=False)
    display_name: Mapped[str] = mapped_column(String(200), nullable=False)
    description: Mapped[str | None] = mapped_column(Text, nullable=True)
    weight: Mapped[Decimal] = mapped_column(
        Numeric(5, 4), default=Decimal("0.1667"), nullable=False
    )  # Default 1/6
    sort_order: Mapped[int] = mapped_column(Integer, default=0, nullable=False)

    indicators: Mapped[list["Indicator"]] = relationship(
        back_populates="category", lazy="selectin"
    )


class Indicator(Base, UUIDPrimaryKeyMixin, TimestampMixin):
    __tablename__ = "indicators"

    category_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True), ForeignKey("indicator_categories.id"), nullable=False
    )
    name: Mapped[str] = mapped_column(String(200), unique=True, nullable=False)
    display_name: Mapped[str] = mapped_column(String(300), nullable=False)
    description: Mapped[str | None] = mapped_column(Text, nullable=True)
    unit: Mapped[str | None] = mapped_column(String(50), nullable=True)
    data_source: Mapped[str | None] = mapped_column(String(200), nullable=True)
    weight: Mapped[Decimal] = mapped_column(Numeric(5, 4), default=Decimal("1.0"), nullable=False)
    is_inverse: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    sort_order: Mapped[int] = mapped_column(Integer, default=0, nullable=False)

    category: Mapped[IndicatorCategory] = relationship(back_populates="indicators")
    values: Mapped[list["IndicatorValue"]] = relationship(back_populates="indicator")


class DataSource(Base, UUIDPrimaryKeyMixin, TimestampMixin):
    __tablename__ = "data_sources"

    name: Mapped[str] = mapped_column(String(200), unique=True, nullable=False)
    source_type: Mapped[str] = mapped_column(String(100), nullable=False)
    description: Mapped[str | None] = mapped_column(Text, nullable=True)
    url: Mapped[str | None] = mapped_column(String(500), nullable=True)
    config: Mapped[dict | None] = mapped_column(JSONB, nullable=True)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    last_fetched_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)


class IndicatorValue(Base, UUIDPrimaryKeyMixin, TimestampMixin):
    __tablename__ = "indicator_values"

    indicator_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True), ForeignKey("indicators.id"), nullable=False
    )
    region_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True), ForeignKey("regions.id"), nullable=False
    )
    data_source_id: Mapped[uuid.UUID | None] = mapped_column(
        UUID(as_uuid=True), ForeignKey("data_sources.id"), nullable=True
    )
    value: Mapped[float] = mapped_column(Float, nullable=False)
    normalized_value: Mapped[float | None] = mapped_column(Float, nullable=True)
    year: Mapped[int] = mapped_column(Integer, nullable=False)
    metadata_json: Mapped[dict | None] = mapped_column(JSONB, nullable=True)

    indicator: Mapped[Indicator] = relationship(back_populates="values")


class SVIScore(Base, UUIDPrimaryKeyMixin, TimestampMixin):
    __tablename__ = "svi_scores"

    region_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True), ForeignKey("regions.id"), nullable=False
    )
    year: Mapped[int] = mapped_column(Integer, nullable=False)
    composite_score: Mapped[float] = mapped_column(Float, nullable=False)
    grade: Mapped[str] = mapped_column(String(2), nullable=False)
    category_scores: Mapped[dict] = mapped_column(JSONB, nullable=False)
    risk_index: Mapped[float | None] = mapped_column(Float, nullable=True)
    normalization_method: Mapped[str] = mapped_column(
        String(50), default="min_max", nullable=False
    )
    calculation_metadata: Mapped[dict | None] = mapped_column(JSONB, nullable=True)
